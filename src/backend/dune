(executable
 (name icoq)
 (modes byte native)
 (preprocess (staged_pps ppx_import ppx_deriving_yojson))
 (libraries coq-core.stm coq-core.toplevel yojson coq-serapi.serlib coq-serapi.serapi_v8_14)
 (ocamlc_flags -no-check-prims)
 (link_flags -linkall))

(rule
 (target wacoq_version.ml)
 (deps ../../package.json)
 (action (with-stdout-to %{target}
  (run node -p
      "`(* autogenerated by src/backend/dune *)
      \n let version = \"${require(\"../../package.json\").version}\"
      \n let date = \"${new Date().toUTCString()}\"`"))))

(rule
 (target dllcoqrun_stubs.wasm)
 (deps byterun_stubs.c)
 (action
  (bash "$WASI_SDK_PATH/bin/clang -target wasm32-unknown-emscripten -D__wasi__ -fPIC \
	  byterun_stubs.c -o %{target} -nostdlib -Wl,--shared -Wl,--export-all \
      -I%{ocaml-config:standard_library} -I$WASI_SDK_PATH/share/wasi-sysroot/include/")))

(rule
 (target dlllib_stubs.wasm)
 (deps lib_stubs.c)
 (action
  (bash "$WASI_SDK_PATH/bin/clang -target wasm32-unknown-emscripten -D__wasi__ -fPIC \
	  lib_stubs.c -o %{target} -nostdlib -Wl,--shared -Wl,--export-all \
      -I%{ocaml-config:standard_library} -I$WASI_SDK_PATH/share/wasi-sysroot/include/")))
